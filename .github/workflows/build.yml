name: Build & Publish Home Assistant Add-ons

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*.*.*'
      - 'v*.*'
      - 'v*'
  pull_request:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  ORG: ${{ github.repository_owner }}
  DEFAULT_PLATFORMS: linux/amd64,linux/arm64,linux/arm/v7

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags/labels
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::7}"

          # Standard: Branch-Push -> latest + sha
          TAGS=("sha-${SHORT_SHA}")
          if [[ "${GITHUB_REF}" == refs/heads/* ]]; then
            TAGS+=("latest")
          fi

          # Wenn Tag-Push (refs/tags/vX.Y[.Z]) -> v-Tag + latest
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            REF_TAG="${GITHUB_REF#refs/tags/}"
            TAGS=("${REF_TAG}" "latest")
          fi

          printf 'tags=%s\n' "$(IFS=,; echo "${TAGS[*]}")" >> "$GITHUB_OUTPUT"
          echo "platforms=${{ env.DEFAULT_PLATFORMS }}" >> "$GITHUB_OUTPUT"

      - name: Discover add-on directories
        id: discover
        shell: bash
        run: |
          set -euo pipefail
          ADDONS="$(find . -maxdepth 2 -type f -name 'config.json' -printf '%h\n' | sed 's|^\./||' | sort -u)"
          if [[ -z "${ADDONS}" ]]; then
            echo "Keine Add-ons (Ordner mit config.json) gefunden." >&2
            exit 1
          fi
          echo "Gefundene Add-ons:"
          echo "${ADDONS}" | sed 's/^/ - /'
          {
            echo 'list<<EOF'
            echo "${ADDONS}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Build & Push all add-ons (multi-arch)
        shell: bash
        run: |
          set -euo pipefail

          PLATFORMS="${{ steps.meta.outputs.platforms }}"
          IFS=',' read -r -a TAGS <<< "${{ steps.meta.outputs.tags }}"

          # Multiline Output -> in Array übernehmen
          mapfile -t ADDONS < <(printf '%s\n' "${{ steps.discover.outputs.list }}")

          for ADDON_DIR in "${ADDONS[@]}"; do
            [[ -z "$ADDON_DIR" ]] && continue
            ADDON_NAME="$(basename "$ADDON_DIR")"
            IMAGE="${{ env.REGISTRY }}/${{ env.ORG }}/ha-addon-${ADDON_NAME}"

            echo "::group::Build ${ADDON_NAME}"
            echo "Building ${IMAGE}"

            TAG_ARGS=()
            for T in "${TAGS[@]}"; do
              [[ -n "$T" ]] && TAG_ARGS+=( --tag "${IMAGE}:${T}" )
            done

            # PRs / Sonderfälle ohne Tags → Fallback-Tag
            if [[ ${#TAG_ARGS[@]} -eq 0 ]]; then
              PR_TAG="pr-${{ github.event.pull_request.number || 'check' }}-${GITHUB_SHA::7}"
              TAG_ARGS=( --tag "${IMAGE}:${PR_TAG}" )
            fi

            docker buildx build \
              --platform "${PLATFORMS}" \
              --provenance=false \
              --sbom=false \
              --cache-from "type=gha" \
              --cache-to "type=gha,mode=max" \
              "${TAG_ARGS[@]}" \
              --push \
              --file "${ADDON_DIR}/Dockerfile" \
              "${ADDON_DIR}"
            echo "::endgroup::"
          done

      - name: Summary
        if: always()
        run: |
          echo "✅ Build abgeschlossen."
          echo "Images liegen unter ghcr.io/${{ env.ORG }}/ha-addon-<addon-folder>:<tags>."